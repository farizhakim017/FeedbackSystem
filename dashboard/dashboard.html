<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Dashboard</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Stylesheet -->
    <link rel="stylesheet" href="dashboard.css">
</head>

<body>

    <div class="container">
        <h1>Feedback Dashboard</h1>

        <!-- ✅ Recent Users Table (New Addition) -->
        <h2>Recent Users</h2>
        <div class="table-container">
            <table id="recent-users-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button onclick="window.location.href='recentuser.html'">View More</button>

        <h2>Feedback Distribution</h2>
        <div class="chart-container">
            <canvas id="feedbackChart"></canvas>
        </div>


        <p><strong>Total Feedbacks:</strong> <span id="total-feedback">Loading...</span></p>


        <h2>Overall Satisfaction</h2>
        <div class="positive-feedback-container">
            <p><strong>Positive Feedback:</strong> <span id="positive-feedback">Loading...</span> </p>
        </div>
        
        <h2>Average Ratings Per Question</h2>
        <table id="feedback-table">
            <thead>
                <tr>
                    <th>Question</th>
                    <th>Average Rating</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="dashboard.js" type="module"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFax_hk9d4qvGPrS3EHsf1ug2jIHpiZuI",
            authDomain: "customerfeedbacksystem-2d20b.firebaseapp.com",
            projectId: "customerfeedbacksystem-2d20b",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Questions
        const questions = [
            "Courteous & Friendly Staff?",
            "Prompt & Clear Information?",
            "Cleanliness of Facility?",
            "Washrooms?",
            "Air Conditioning?",
            "Medical Equipment?",
            "Your waiting time?",
            "Overall experience?"
        ];

        let feedbackCount = 0;
        let questionSums = Array(questions.length).fill(0);
        let feedbackChart;

        function fetchFeedbackData() {
            db.collection("feedback").get().then(snapshot => {
                feedbackCount = snapshot.size;
                let ratingsCount = Array(5).fill(0);

                snapshot.forEach(doc => {
                    let responses = doc.data().responses;
                    responses.forEach((rating, index) => {
                        questionSums[index] += rating;
                        ratingsCount[rating - 1]++;
                    });
                });

                updateDashboard(ratingsCount);
            });
        }

        function updateDashboard(ratingsCount) {
            document.getElementById("total-feedback").textContent = feedbackCount;
            let positiveResponses = 0;

            let tableBody = document.querySelector("#feedback-table tbody");
            tableBody.innerHTML = "";

            questionSums.forEach((sum, index) => {
                let avg = feedbackCount ? (sum / feedbackCount).toFixed(2) : 0;
                let row = `<tr><td>${questions[index]}</td><td>${avg}</td></tr>`;
                tableBody.innerHTML += row;
                if (avg >= 4) positiveResponses++;
            });

            let positivePercentage = ((positiveResponses / questions.length) * 100).toFixed(2);
            document.getElementById("positive-feedback").textContent = positivePercentage;

            generateChart(ratingsCount);
        }

        function generateChart(ratingsCount) {
            let ctx = document.getElementById("feedbackChart").getContext("2d");
            if (feedbackChart) feedbackChart.destroy();
            feedbackChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["😡 Very Not Satisfied", "😞 Not Satisfied", "😐 Decent", "😊 Good", "😍 Excellent"],
                    datasets: [{
                        label: "Number of Ratings",
                        data: ratingsCount,
                        backgroundColor: ["#e74c3c", "#f39c12", "#f1c40f", "#2ecc71", "#3498db"],
                    }]
                }
            });
        }

        fetchFeedbackData();

        // ✅ Fetch Recent Users (New Addition)
        function fetchRecentUsers() {
            db.collection("users")
                .orderBy("timestamp", "desc")
                .limit(3)
                .get()
                .then(snapshot => {
                    let tableBody = document.querySelector("#recent-users-table tbody");
                    tableBody.innerHTML = "";

                    snapshot.forEach(doc => {
                        let data = doc.data();
                        let row = `<tr>
                            <td>${data.name || "Unknown"}</td>
                            <td>${data.email || "No Email"}</td>
                            <td>${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : "N/A"}</td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    });
                });
        }

        fetchRecentUsers();
    </script>

</body>

</html>